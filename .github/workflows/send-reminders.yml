name: Send Reminder Notifications

on:
  schedule:
    # Run every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  send-reminders:
    runs-on: ubuntu-latest
    
    steps:
      - name: Send notifications via OneSignal
        env:
          ONESIGNAL_API_KEY: ${{ secrets.ONESIGNAL_API_KEY }}
          ONESIGNAL_APP_ID: ${{ secrets.ONESIGNAL_APP_ID }}
        run: |
          # Get current hour in Vietnam timezone (UTC+7)
          CURRENT_HOUR=$(TZ='Asia/Ho_Chi_Minh' date +%H):00
          echo "Current Vietnam time hour: $CURRENT_HOUR"
          
          # Call OneSignal API to send notifications to users with matching reminder_time
          curl -X POST https://api.onesignal.com/notifications \
            -H "Content-Type: application/json" \
            -H "Authorization: Key $ONESIGNAL_API_KEY" \
            -d "{
              \"app_id\": \"$ONESIGNAL_APP_ID\",
              \"filters\": [
                {\"field\": \"tag\", \"key\": \"reminder_enabled\", \"relation\": \"=\", \"value\": \"true\"},
                {\"operator\": \"AND\"},
                {\"field\": \"tag\", \"key\": \"reminder_time\", \"relation\": \"=\", \"value\": \"$CURRENT_HOUR\"}
              ],
              \"headings\": {\"en\": \"üìö VocabMaster\"},
              \"contents\": {\"en\": \"ƒê√£ ƒë·∫øn gi·ªù √¥n t·∫≠p t·ª´ v·ª±ng! H√£y d√†nh 5 ph√∫t ƒë·ªÉ h·ªçc nh√© üî•\"},
              \"url\": \"https://vocabulary.click\"
            }"
